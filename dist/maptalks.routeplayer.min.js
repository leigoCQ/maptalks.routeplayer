/*!
 * maptalks.routeplayer v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@^0.23.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function i(t,e){for(var i=Object.getOwnPropertyNames(e),r=0;r<i.length;r++){var o=i[r],n=Object.getOwnPropertyDescriptor(e,o);n&&n.configurable&&void 0===t[o]&&Object.defineProperty(t,o,n)}return t}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):i(t,e))}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var s=function(){function t(e){n(this,t),this.route=e,this.path=e.path}return t.prototype.getCoordinates=function(t,i){if(t<this.getStart()||t>this.getEnd())return null;for(var r=null,o=0,n=this.path.length;o<n;o++)if(t<this.path[o][2]){r=o;break}null===r&&(r=this.path.length-1);var s=this.path[r-1],a=this.path[r],p=t-s[2],h=p/(a[2]-s[2]),l=s[0]+(a[0]-s[0])*h,u=s[1]+(a[1]-s[1])*h,y=new e.Coordinate(l,u),f=i.coordinateToViewPoint(y);return{coordinate:y,viewPoint:f,degree:e.Util.computeDegree(i.coordinateToViewPoint(new e.Coordinate(s)),f),index:r}},t.prototype.getStart=function(){return this.path[0][2]},t.prototype.getEnd=function(){return this.path[this.getCount()-1][2]},t.prototype.getCount=function(){return this.path.length},t}(),a={unitTime:1e3,showRoutes:!0,markerSymbol:null,lineSymbol:{lineWidth:2,lineColor:"#004A8D"}},p=function(t){function i(o,s,a){n(this,i);var p=r(this,t.call(this,a));return Array.isArray(o)||(o=[o]),p.id=e.Util.UID(),p._map=s,p._registerEvents(),p._setup(o),p}return o(i,t),i.prototype.remove=function(){this.finish(),this._removeEvents(),this.markerLayer.remove(),this.lineLayer.remove(),delete this._map},i.prototype.play=function(){return this.player.play(),this.fire("playstart"),this},i.prototype.pause=function(){return this.player.pause(),this.fire("playpause"),this},i.prototype.cancel=function(){return this.player.cancel(),this.played=0,this._createPlayer(),this._step({styles:{t:0}}),this.fire("playcancel"),this},i.prototype.finish=function(){return this.player.finish(),this._step({styles:{t:1}}),this.fire("playfinish"),this},i.prototype.getCurrentTime=function(){return this.played?this.startTime+this.played:this.startTime},i.prototype.setTime=function(t){return this.played=t-this.startTime,this.played<0&&(this.played=0),this._resetPlayer(),this},i.prototype.getUnitTime=function(){return this.options.unitTime},i.prototype.setUnitTime=function(t){this.options.unitTime=+t,this._resetPlayer()},i.prototype.getCurrentCoordinates=function(t){return t||(t=0),this.routes[t]&&this.routes[t]._painter?this.routes[t]._painter.marker.getCoordinates():null},i.prototype._resetPlayer=function(){var t=this.player&&"running"===this.player.playState;t&&this.player.finish(),this._createPlayer(),t&&this.player.play()},i.prototype._step=function(t){this.played=this.duration*t.styles.t;for(var e=0,i=this.routes.length;e<i;e++)this._drawRoute(this.routes[e],this.startTime+this.played);this.fire("playing")},i.prototype._drawRoute=function(t,i){if(this._map){var r=t.getCoordinates(i,this._map);if(r)if(t._painter)t._painter.marker.setCoordinates(r.coordinate);else{t._painter={};var o=new e.Marker(r.coordinate,{symbol:t.markerSymbol||this.options.markerSymbol}).addTo(this.markerLayer),n=new e.LineString(t.path,{symbol:t.lineSymbol||this.options.lineSymbol}).addTo(this.lineLayer);t._painter.marker=o,t._painter.line=n}}},i.prototype._setup=function(t){for(var e=t.map(function(t){return new s(t)}),i=e[0].getStart(),r=e[0].getEnd(),o=1;o<e.length;o++){var n=e[o];n.getStart()<i&&(i=n.getStart()),n.getEnd()>r&&(r=n.getEnd())}this.routes=e,this.startTime=i,this.endTime=r,this.played=0,this.duration=r-i,this._createLayers(),this._createPlayer()},i.prototype._createPlayer=function(){var t=(this.duration-this.played)/this.options.unitTime;this.player=e.animation.Animation.animate({t:[this.played/this.duration,1]},{speed:t,easing:"linear"},this._step.bind(this))},i.prototype._createLayers=function(){this.lineLayer=new e.VectorLayer(e.INTERNAL_LAYER_PREFIX+"_routeplay_r_"+this.id).addTo(this._map),this.markerLayer=new e.VectorLayer(e.INTERNAL_LAYER_PREFIX+"_routeplay_m_"+this.id).addTo(this._map)},i.prototype._registerEvents=function(){this._map.on("zoomstart",this.onZoomStart,this).on("zoomend",this.onZoomEnd,this)},i.prototype._removeEvents=function(){this._map.off("zoomstart",this.onZoomStart,this).off("zoomend",this.onZoomEnd,this)},i.prototype.onZoomStart=function(){this.player&&this.player.pause()},i.prototype.onZoomEnd=function(){this.player&&this.player.play()},i}(e.Eventable(e.Class));p.mergeOptions(a),t.Route=s,t.RoutePlayer=p,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.routeplayer v0.1.0, requires maptalks@^0.23.0.")});